import{a as Me}from"./DeleteLinkedDocModal-975a2092.js";import{_ as Se}from"./ErrorPage-0b86b18d.js";import{_ as Re}from"./Icon-911fc80b.js";import{D as le}from"./DetailsIcon-e50d569c.js";import{u as $e,b as Ee,A as Te,a as ze,S as Pe,L as Le,c as Oe}from"./useActiveTabManager-e96a6eab.js";import{E as Ue}from"./Popover-1d5c4a4a.js";import{E as Be}from"./Email2Icon-7274297f.js";import{C as Ne}from"./CommentIcon-c7b6928f.js";import{P as ne}from"./PhoneIcon-69e5860b.js";import{T as Fe}from"./TaskIcon-a01c592b.js";import{N as qe}from"./NoteModal-9bc91804.js";import{W as je}from"./WhatsAppIcon-7e3c5013.js";import{I as We}from"./IndicatorIcon-04037c64.js";import{A as Qe}from"./ArrowUpRightIcon-6ec7123f.js";import{g as Ze,S as Ge,a as He}from"./view-1d92bf2c.js";import{_ as Je}from"./LayoutHeader-5e92fb27.js";import{_ as Ke}from"./OrganizationModal-7bf94a32.js";import{_ as Xe}from"./LostReasonModal-8b9e07aa.js";import{C as Ye}from"./ContactModal-8971feb0.js";import{u as ea,b as aa,_ as ta}from"./modals-743ca193.js";import{_ as oa}from"./Link-23bb92d9.js";import{_ as re}from"./CustomActions-ee6e6093.js";import{b as sa,a as la,s as na}from"./index-0265294d.js";import{g as ra}from"./settings-6032aff8.js";import{g as ia}from"./global-e5531a29.js";import{s as ca}from"./statuses-c267cbc8.js";import{i as da,c as ua,w as ma}from"./DragVerticalIcon-8094d966.js";import{W as _a,$ as pa,l as y,x as z,y as ie,T as ce,r as W,b as t,c as p,d as i,w as m,u as o,e as f,g as _,A as d,ai as de,F as ue,a1 as b,a0 as P,n as Q,t as A,f as fa,Q as me,Z as va}from"./index-60fe5464.js";import{u as ya}from"./pageMeta-11871c03.js";import{_ as ga}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-19611549.js";import{D as _e}from"./dayjs-94ac47e4.js";import"./ListView-018dab64.js";import"./CalendarIcon-0e52e5ad.js";import"./CallLogModal-6f2e75fc.js";import"./ContactsIcon-5dc501e8.js";import"./LeadsIcon-b6bd92f0.js";import"./DealsIcon-409ec3d9.js";import"./TaskModal-7c562484.js";import"./onboarding-c8157b76.js";import"./FadedScrollableDiv-89265c8d.js";import"./FieldLayout-e663f0b5.js";import"./MultipleAvatar-59dbe3ef.js";import"./IconPicker-bb1599d9.js";import"./FileUploader-d35e30d1.js";import"./fileUploadHandler-0b2042a3.js";import"./plus-1db3389e.js";const ha={class:"relative flex h-10.5 items-center justify-between gap-2 py-2.5 pl-2"},ba={class:"absolute right-0"},Ca={key:0,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},ka={class:"flex items-center gap-2"},xa={key:1,class:"flex h-full overflow-hidden"},wa={key:0},Ia={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Da={key:0,class:"pr-2"},Va={key:0,class:"contacts-area"},Aa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Ma={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},Sa=["onClick"],Ra={class:"truncate"},$a={class:"flex items-center"},Ea={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},Ta={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},za={class:"flex items-center gap-3 p-1 py-1.5"},Pa={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},La={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},St={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(I){const{brand:pe}=ra(),{$dialog:fe,$socket:ve}=ia(),{statusOptions:ye,getDealStatus:L}=ca(),{doctypeMeta:ge}=sa("CRM Deal"),C=_a(),O=pa(),g=I,M=y(""),U=y(""),S=y(!1),{triggerOnChange:he,assignees:B,document:u,scripts:Z,error:be}=ea("CRM Deal",g.dealId),l=z(()=>u.doc||{});ie(be,e=>{var a;e?(M.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),U.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(M.value="",U.value="")}),ie(()=>u.doc,async e=>{var a;if((a=Z.data)!=null&&a.length){let s=await na(Z.data,{doc:e,$dialog:fe,$socket:ve,router:O,toast:b,updateField:q,createToast:b.create,deleteDoc:De,call:P});u._actions=s.actions||[],u._statuses=s.statuses||[]}},{once:!0});const N=y(!1),R=y(!1),G=y({}),Ce=z(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(C.query.view||C.query.viewType){let a=Ze(C.query.view,C.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:C.query.viewType},query:{view:C.query.view}}})}return e.push({label:H.value,route:{name:"Deal",params:{dealId:g.dealId}}}),e}),H=z(()=>{var a,s;let e=((a=ge["CRM Deal"])==null?void 0:a.title_field)||"name";return((s=l.value)==null?void 0:s[e])||g.dealId});ya(()=>({title:H.value,icon:pe.favicon}));const F=z(()=>[{name:"Details",label:__("Details"),icon:le,condition:()=>da.value},{name:"Activity",label:__("Activity"),icon:Te},{name:"Emails",label:__("Emails"),icon:Ue},{name:"Comments",label:__("Comments"),icon:Ne},{name:"Data",label:__("Data"),icon:le},{name:"Calls",label:__("Calls"),icon:ne,condition:()=>ua.value},{name:"Tasks",label:__("Tasks"),icon:Fe},{name:"Notes",label:__("Notes"),icon:qe},{name:"Attachments",label:__("Attachments"),icon:ze},{name:"WhatsApp",label:__("WhatsApp"),icon:je,condition:()=>ma.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:k}=$e(F,"lastDealTab"),$=ce({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},auto:!0,transform:e=>ke(e)});function ke(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(s=>{s.name=="organization"&&(s.create=(n,w)=>{G.value.organization_name=n,R.value=!0,w()},s.link=n=>O.push({name:"Organization",params:{organizationId:n}}))})}),e}const E=y(!1),J=y({});function xe(e){let a=[{label:__("Delete"),icon:"trash-2",onClick:()=>we(e)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:va(He,{class:"h-4 w-4"}),onClick:()=>Ie(e.name)}),a}async function K(e){var s;if((s=x.data)!=null&&s.find(n=>n.name===e)){b.error(__("Contact already added"));return}await P("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:g.dealId,contact:e})&&(x.reload(),b.success(__("Contact added")))}async function we(e){await P("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:g.dealId,contact:e})&&(x.reload(),b.success(__("Contact removed")))}async function Ie(e){await P("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:g.dealId,contact:e})&&(x.reload(),b.success(__("Primary contact set")))}const x=ce({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:g.dealId},cache:["deal_contacts",g.dealId],auto:!0,onSuccess:e=>{var s;let a=(s=$.data)==null?void 0:s.find(n=>n.name=="contacts_section");a&&(a.contacts=e.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))}});function q(e,a){a=Array.isArray(e)?"":a;let s=Array.isArray(e)?{}:l.value[e];Array.isArray(e)?e.forEach(n=>l.value[n]=a):l.value[e]=a,u.save.submit(null,{onSuccess:()=>N.value=!0,onError:n=>{var w;Array.isArray(e)?e.forEach(D=>l.value[D]=s[D]):l.value[e]=s,b.error(((w=n.messages)==null?void 0:w[0])||__("Error updating field"))}})}function De(){S.value=!0}async function Ve(e){await he("status",e),X()}const T=y(!1);function X(){if(L(l.status).type!=="Lost"||l.lost_reason&&l.lost_reason!=="Other"||l.lost_reason==="Other"&&l.lost_notes){u.save.submit();return}T.value=!0}function Y(e){e!=null&&e.hasOwnProperty("status")&&L(e.status).type=="Lost"?X():u.save.submit(null,{onSuccess:()=>j(e)})}function j(e){e!=null&&e.hasOwnProperty("deal_owner")&&B.reload()}return(e,a)=>{var D,ee;const s=W("Button"),n=W("Badge"),w=W("FeatherIcon");return t(),p(ue,null,[i(Je,null,{default:m(()=>{var r;return[f("header",ha,[i(o(ga),{items:Ce.value},{prefix:m(({item:c})=>[c.icon?(t(),_(Re,{key:0,icon:c.icon,class:"mr-2 h-4"},null,8,["icon"])):d("",!0)]),_:1},8,["items"]),f("div",ba,[l.value?(t(),_(o(_e),{key:0,options:o(ye)("deal",(r=o(u).statuses)!=null&&r.length?o(u).statuses:o(u)._statuses,Ve)},{default:m(({open:c})=>[l.value.status?(t(),_(s,{key:0,label:l.value.status,iconRight:c?"chevron-up":"chevron-down"},{prefix:m(()=>[i(We,{class:Q(o(L)(l.value.status).color)},null,8,["class"])]),_:1},8,["label","iconRight"])):d("",!0)]),_:1},8,["options"])):d("",!0)])])]}),_:1}),l.value.name?(t(),p("div",Ca,[i(Ee,{modelValue:o(B).data,"onUpdate:modelValue":a[0]||(a[0]=r=>o(B).data=r),doctype:"CRM Deal",docname:I.dealId},null,8,["modelValue","docname"]),f("div",ka,[(D=o(u)._actions)!=null&&D.length?(t(),_(re,{key:0,actions:o(u)._actions},null,8,["actions"])):d("",!0),(ee=o(u).actions)!=null&&ee.length?(t(),_(re,{key:1,actions:o(u).actions},null,8,["actions"])):d("",!0)])])):d("",!0),l.value.name?(t(),p("div",xa,[i(o(ta),{as:"div",modelValue:o(k),"onUpdate:modelValue":a[5]||(a[5]=r=>de(k)?k.value=r:null),tabs:F.value,class:"flex flex-1 overflow-auto flex-col [&_[role='tab']]:px-0 [&_[role='tablist']]:px-3 [&_[role='tablist']]:gap-7.5 [&_[role='tabpanel']:not([hidden])]:flex [&_[role='tabpanel']:not([hidden])]:grow"},{"tab-panel":m(({tab:r})=>[r.name=="Details"?(t(),p("div",wa,[l.value.sla_status?(t(),_(Pe,{key:0,modelValue:l.value,"onUpdate:modelValue":a[1]||(a[1]=c=>l.value=c),onUpdateField:q},null,8,["modelValue"])):d("",!0),o($).data?(t(),p("div",Ia,[i(Ge,{sections:o($).data,doctype:"CRM Deal",docname:I.dealId,onReload:o($).reload,onBeforeFieldChange:Y,onAfterFieldChange:j},{actions:m(({section:c})=>[c.name=="contacts_section"?(t(),p("div",Da,[i(oa,{value:"",doctype:"Contact",onChange:a[2]||(a[2]=h=>K(h)),onCreate:(h,V)=>{J.value={first_name:h,company_name:l.value.organization},E.value=!0,V()}},{target:m(({togglePopover:h})=>[i(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:V=>h()},null,8,["onClick"])]),_:1},8,["onCreate"])])):d("",!0)]),default:m(({section:c})=>{var h,V,ae;return[c.name=="contacts_section"?(t(),p("div",Va,[(h=o(x))!=null&&h.loading&&((ae=(V=o(x))==null?void 0:V.data)==null?void 0:ae.length)==0?(t(),p("div",Aa,[i(Le,{class:"h-4 w-4"}),f("span",null,A(e.__("Loading...")),1)])):c.contacts.length?(t(!0),p(ue,{key:1},fa(c.contacts,(v,te)=>(t(),p("div",{key:v.name},[f("div",{class:Q(["px-2 pb-2.5",[te==0?"pt-5":"pt-2.5"]])},[i(aa,{opened:v.opened},{header:m(({opened:Ae,toggle:oe})=>[f("div",Ma,[f("div",{class:"flex h-7 items-center gap-2 truncate",onClick:se=>oe()},[i(o(la),{label:v.full_name,image:v.image,size:"md"},null,8,["label","image"]),f("div",Ra,A(v.full_name),1),v.is_primary?(t(),_(n,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):d("",!0)],8,Sa),f("div",$a,[i(o(_e),{options:xe(v.name)},{default:m(()=>[i(s,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:1},8,["options"]),i(s,{variant:"ghost",onClick:se=>o(O).push({name:"Contact",params:{contactId:v.name}})},{default:m(()=>[i(Qe,{class:"h-4 w-4"})]),_:1},8,["onClick"]),i(s,{variant:"ghost",onClick:se=>oe()},{default:m(()=>[i(w,{name:"chevron-right",class:Q(["h-4 w-4 text-ink-gray-9 transition-all duration-300 ease-in-out",{"rotate-90":Ae}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:m(()=>[f("div",Ea,[f("div",Ta,[i(Be,{class:"h-4 w-4"}),me(" "+A(v.email),1)]),f("div",za,[i(ne,{class:"h-4 w-4"}),me(" "+A(v.mobile_no),1)])])]),_:2},1032,["opened"])],2),te!=c.contacts.length-1?(t(),p("div",Pa)):d("",!0)]))),128)):(t(),p("div",La,A(e.__("No contacts added")),1))])):d("",!0)]}),_:1},8,["sections","docname","onReload"])])):d("",!0)])):(t(),_(Oe,{key:1,doctype:"CRM Deal",docname:I.dealId,tabs:F.value,reload:N.value,"onUpdate:reload":a[3]||(a[3]=c=>N.value=c),tabIndex:o(k),"onUpdate:tabIndex":a[4]||(a[4]=c=>de(k)?k.value=c:null),onBeforeSave:Y,onAfterSave:j},null,8,["docname","tabs","reload","tabIndex"]))]),_:1},8,["modelValue","tabs"])])):M.value?(t(),_(Se,{key:2,errorTitle:M.value,errorMessage:U.value},null,8,["errorTitle","errorMessage"])):d("",!0),R.value?(t(),_(Ke,{key:3,modelValue:R.value,"onUpdate:modelValue":a[6]||(a[6]=r=>R.value=r),data:G.value,options:{redirect:!1,afterInsert:r=>q("organization",r.name)}},null,8,["modelValue","data","options"])):d("",!0),E.value?(t(),_(Ye,{key:4,modelValue:E.value,"onUpdate:modelValue":a[7]||(a[7]=r=>E.value=r),contact:J.value,options:{redirect:!1,afterInsert:r=>K(r.name)}},null,8,["modelValue","contact","options"])):d("",!0),S.value?(t(),_(Me,{key:5,modelValue:S.value,"onUpdate:modelValue":a[8]||(a[8]=r=>S.value=r),doctype:"CRM Deal",docname:I.dealId,name:"Deals"},null,8,["modelValue","docname"])):d("",!0),T.value?(t(),_(Xe,{key:6,modelValue:T.value,"onUpdate:modelValue":a[9]||(a[9]=r=>T.value=r),deal:o(u)},null,8,["modelValue","deal"])):d("",!0)],64)}}};export{St as default};
//# sourceMappingURL=MobileDeal-9b891ecd.js.map
