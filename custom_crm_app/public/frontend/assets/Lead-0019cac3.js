import{a as be}from"./DeleteLinkedDocModal-975a2092.js";import{_ as ye}from"./ErrorPage-0b86b18d.js";import{_ as he}from"./Icon-911fc80b.js";import{_ as Ce}from"./Resizer-87ba515d.js";import{u as ke,_ as xe,A as we,a as te,b as Me,c as Ie,S as Ee}from"./useActiveTabManager-e96a6eab.js";import{E as Ve}from"./Popover-1d5c4a4a.js";import{E as $e}from"./Email2Icon-7274297f.js";import{C as Re}from"./CommentIcon-c7b6928f.js";import{D as De}from"./DetailsIcon-e50d569c.js";import{P as oe}from"./PhoneIcon-69e5860b.js";import{T as Le}from"./TaskIcon-a01c592b.js";import{N as Se}from"./NoteModal-9bc91804.js";import{W as Ae}from"./WhatsAppIcon-7e3c5013.js";import{I as Te}from"./IndicatorIcon-04037c64.js";import{C as ze}from"./CameraIcon-806f9666.js";import{L as qe}from"./LinkIcon-5c2e5cca.js";import{_ as Ue}from"./LayoutHeader-5e92fb27.js";import{g as Fe,S as Oe}from"./view-1d92bf2c.js";import{_ as le}from"./CustomActions-ee6e6093.js";import{O as Ne}from"./OrganizationsIcon-5004b6fe.js";import{C as je}from"./ContactsIcon-5dc501e8.js";import{i as Be,E as Pe,w as We,c as Qe}from"./DragVerticalIcon-8094d966.js";import{F as Ge}from"./FieldLayout-e663f0b5.js";import{_ as se}from"./Link-23bb92d9.js";import{u as ee,c as Xe,q as He,_ as Je}from"./modals-743ca193.js";import{L as Ke,M as Ye,$ as de,V as Ze,X as ea,l as y,x as A,T as ce,r as Q,b as i,g as d,w as v,e as u,t as E,u as o,A as m,d as n,c as U,S as aa,a0 as me,aj as ta,W as oa,y as ne,ah as la,ai as ie,F as sa,n as na,I as ia,a2 as ra,U as ua,a1 as q,E as da}from"./index-60fe5464.js";import{s as pe}from"./statuses-c267cbc8.js";import{u as ca}from"./onboarding-c8157b76.js";import{_ as re,D as ue}from"./dayjs-94ac47e4.js";import{b as ma,e as pa,v as va,a as fa,o as _a,s as ga}from"./index-0265294d.js";import{g as ba}from"./settings-6032aff8.js";import{g as ya}from"./global-e5531a29.js";import{u as ha}from"./pageMeta-11871c03.js";import{_ as Ca}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-19611549.js";import{F as ka}from"./FileUploader-d35e30d1.js";import"./ListView-018dab64.js";import"./CalendarIcon-0e52e5ad.js";import"./CallLogModal-6f2e75fc.js";import"./ArrowUpRightIcon-6ec7123f.js";import"./LeadsIcon-b6bd92f0.js";import"./DealsIcon-409ec3d9.js";import"./TaskModal-7c562484.js";import"./FadedScrollableDiv-89265c8d.js";import"./MultipleAvatar-59dbe3ef.js";import"./IconPicker-bb1599d9.js";import"./plus-1db3389e.js";import"./fileUploadHandler-0b2042a3.js";const xa={class:"mb-6 flex items-center justify-between"},wa={class:"text-2xl font-semibold leading-6 text-ink-gray-9"},Ma={class:"flex items-center gap-1"},Ia={class:"mb-4 flex items-center gap-2 text-ink-gray-5"},Ea={class:"block text-base"},Va={class:"ml-6 text-ink-gray-9"},$a={class:"flex items-center justify-between text-base"},Ra={key:1,class:"mt-2.5 text-base"},Da={class:"mb-4 mt-6 flex items-center gap-2 text-ink-gray-5"},La={class:"block text-base"},Sa={class:"ml-6 text-ink-gray-9"},Aa={class:"flex items-center justify-between text-base"},Ta={key:1,class:"mt-2.5 text-base"},za={key:0,class:"h-px w-full border-t my-6"},qa={class:"flex justify-end"},Ua={__name:"ConvertToDealModal",props:Ke({lead:{type:Object,required:!0}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(h){const F=h,V=Ye(h,"modelValue"),G=de(),{statusOptions:X,getDealStatus:H}=pe(),{isManager:J}=Ze(),{user:K}=ea(),{updateOnboardingStep:$}=ca("frappecrm"),R=y(!1),w=y(!1),C=y(""),f=y(""),p=y(""),{triggerConvertToDeal:D}=ee("CRM Lead",F.lead.name),{document:_}=ee("CRM Deal");async function T(){if(p.value="",R.value&&!C.value){p.value=__("Please select an existing contact");return}if(w.value&&!f.value){p.value=__("Please select an existing organization");return}!R.value&&C.value&&(C.value=""),!w.value&&f.value&&(f.value=""),await(D==null?void 0:D(F.lead,_.doc,()=>V.value=!1));let r=await me("crm.fcrm.doctype.crm_lead.crm_lead.convert_to_deal",{lead:F.lead.name,deal:_.doc,existing_contact:C.value,existing_organization:f.value}).catch(t=>{var k;if(t.exc_type=="MandatoryError"){const I=t.messages.map(g=>{let l=g.split(": ");return l[l.length-1].trim()}).join(", ");I.toLowerCase().includes("required")?p.value=__(I):p.value=__("{0} is required",[I]);return}p.value=__("Error converting to deal: {0}",[(k=t.messages)==null?void 0:k[0]])});r&&(V.value=!1,R.value=!1,w.value=!1,C.value="",f.value="",p.value="",$("convert_lead_to_deal",!0,!1,()=>{localStorage.setItem("firstDeal"+K,r)}),ta("convert_lead_to_deal"),G.push({name:"Deal",params:{dealId:r}}))}const O=A(()=>{var t;let r=X("deal");return(t=_.doc)!=null&&t.status||(_.doc.status=r[0].value),r}),N=ce({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["RequiredFields","CRM Deal"],params:{doctype:"CRM Deal",type:"Required Fields"},auto:!0,transform:r=>{let t=!1,k=r==null?void 0:r.forEach(I=>{var g;(g=I.sections)==null||g.forEach(l=>{var b;(b=l.columns)==null||b.forEach(z=>{var P;(P=z.fields)==null||P.forEach(x=>{t=!0,x.fieldname=="status"&&(x.fieldtype="Select",x.options=O.value,x.prefix=H(_.doc.status).color),x.fieldtype==="Table"&&(_.doc[x.fieldname]=[])})})})});return t?k:[]}});function j(){Xe.value=!0,He.value={doctype:"CRM Deal",onlyRequired:!0},V.value=!1}return(r,t)=>{const k=Q("Button"),I=Q("ErrorMessage");return i(),d(o(aa),{modelValue:V.value,"onUpdate:modelValue":t[5]||(t[5]=g=>V.value=g),options:{size:"xl"}},{"body-header":v(()=>[u("div",xa,[u("div",null,[u("h3",wa,E(r.__("Convert to Deal")),1)]),u("div",Ma,[o(J)()&&!o(Be)?(i(),d(k,{key:0,variant:"ghost",tooltip:r.__("Edit deal's mandatory fields layout"),icon:Pe,onClick:j},null,8,["tooltip"])):m("",!0),n(k,{icon:"x",variant:"ghost",onClick:t[0]||(t[0]=g=>V.value=!1)})])])]),"body-content":v(()=>{var g,l;return[u("div",Ia,[n(Ne,{class:"h-4 w-4"}),u("label",Ea,E(r.__("Organization")),1)]),u("div",Va,[u("div",$a,[u("div",null,E(r.__("Choose Existing")),1),n(o(re),{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=b=>w.value=b)},null,8,["modelValue"])]),w.value?(i(),d(se,{key:0,class:"form-control mt-2.5",size:"md",value:f.value,doctype:"CRM Organization",onChange:t[2]||(t[2]=b=>f.value=b)},null,8,["value"])):(i(),U("div",Ra,E(r.__("New organization will be created based on the data in details section")),1))]),u("div",Da,[n(je,{class:"h-4 w-4"}),u("label",La,E(r.__("Contact")),1)]),u("div",Sa,[u("div",Aa,[u("div",null,E(r.__("Choose Existing")),1),n(o(re),{modelValue:R.value,"onUpdate:modelValue":t[3]||(t[3]=b=>R.value=b)},null,8,["modelValue"])]),R.value?(i(),d(se,{key:0,class:"form-control mt-2.5",size:"md",value:C.value,doctype:"Contact",onChange:t[4]||(t[4]=b=>C.value=b)},null,8,["value"])):(i(),U("div",Ta,E(r.__("New contact will be created based on the person's details")),1))]),(g=o(N).data)!=null&&g.length?(i(),U("div",za)):m("",!0),(l=o(N).data)!=null&&l.length?(i(),d(Ge,{key:1,tabs:o(N).data,data:o(_).doc,doctype:"CRM Deal"},null,8,["tabs","data"])):m("",!0),n(I,{class:"mt-4",message:p.value},null,8,["message"])]}),actions:v(()=>[u("div",qa,[n(k,{label:r.__("Convert"),variant:"solid",onClick:T},null,8,["label"])])]),_:1},8,["modelValue"])}}},Fa={key:0,class:"flex h-full overflow-hidden"},Oa={class:"flex items-center justify-start gap-5 border-b p-5"},Na={class:"group relative size-12"},ja={class:"z-1 absolute bottom-0.5 left-0 right-0.5 flex h-9 cursor-pointer items-center justify-center rounded-b-full bg-black bg-opacity-40 pt-3 opacity-0 duration-300 ease-in-out group-hover:opacity-100",style:{"-webkit-clip-path":"inset(12px 0 0 0)","clip-path":"inset(12px 0 0 0)"}},Ba={class:"flex flex-col gap-2.5 truncate"},Pa={class:"truncate text-2xl font-medium text-ink-gray-9"},Wa={class:"flex gap-1.5"},Qa={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Ot={__name:"Lead",props:{leadId:{type:String,required:!0}},setup(h){const{brand:F}=ba(),{$dialog:V,$socket:G,makeCall:X}=ya(),{statusOptions:H,getLeadStatus:J}=pe(),{doctypeMeta:K}=ma("CRM Lead"),$=oa(),R=de(),w=h,C=y(!1),f=y(null),p=y(""),D=y(""),_=y(!1),T=y(!1),O=y(!1),{triggerOnChange:N,assignees:j,permissions:r,document:t,scripts:k,error:I}=ee("CRM Lead",w.leadId),g=A(()=>{var e,a;return((a=(e=r.data)==null?void 0:e.permissions)==null?void 0:a.delete)||!1}),l=A(()=>t.doc||{});ne(I,e=>{var a;e?(p.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),D.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(p.value="",D.value="")}),ne(()=>t.doc,async e=>{var a;if((a=k.data)!=null&&a.length){let c=await ga(k.data,{doc:e,$dialog:V,$socket:G,router:R,toast:q,updateField:W,createToast:q.create,deleteDoc:ae,call:me});t._actions=c.actions||[],t._statuses=c.statuses||[]}},{once:!0});const b=A(()=>{let e=[{label:__("Leads"),route:{name:"Leads"}}];if($.query.view||$.query.viewType){let a=Fe($.query.view,$.query.viewType,"CRM Lead");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Leads",params:{viewType:$.query.viewType},query:{view:$.query.view}}})}return e.push({label:z.value,route:{name:"Lead",params:{leadId:w.leadId}}}),e}),z=A(()=>{var a,c;let e=((a=K["CRM Lead"])==null?void 0:a.title_field)||"name";return((c=l.value)==null?void 0:c[e])||w.leadId}),P=A(()=>{var a;let e=(a=t.statuses)!=null&&a.length?t.statuses:t._statuses||[];return H("lead",e,fe)});ha(()=>({title:z.value,icon:F.favicon}));const x=A(()=>[{name:"Activity",label:__("Activity"),icon:we},{name:"Emails",label:__("Emails"),icon:Ve},{name:"Comments",label:__("Comments"),icon:Re},{name:"Data",label:__("Data"),icon:De},{name:"Calls",label:__("Calls"),icon:oe},{name:"Tasks",label:__("Tasks"),icon:Le},{name:"Notes",label:__("Notes"),icon:Se},{name:"Attachments",label:__("Attachments"),icon:te},{name:"WhatsApp",label:__("WhatsApp"),icon:Ae,condition:()=>We.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:L,changeTabTo:ve}=ke(x,"lastLeadTab"),Y=ce({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Lead"],params:{doctype:"CRM Lead"},auto:!0});async function fe(e){await N("status",e),t.save.submit()}function W(e,a){a=Array.isArray(e)?"":a;let c=Array.isArray(e)?{}:l.value[e];Array.isArray(e)?e.forEach(B=>l.value[B]=a):l.value[e]=a,t.save.submit(null,{onSuccess:()=>C.value=!0,onError:B=>{var s;Array.isArray(e)?e.forEach(M=>l.value[M]=c[M]):l.value[e]=c,q.error(((s=B.messages)==null?void 0:s[0])||__("Error updating field"))}})}function ae(){_.value=!0}function _e(){let e=x.value[L.value];["Emails","Comments","Activities"].includes(e.name)||f.value.changeTabTo("emails"),da(()=>f.value.emailBox.show=!0)}function ge(e){t.save.submit(null,{onSuccess:()=>Z(e)})}function Z(e){e!=null&&e.hasOwnProperty("lead_owner")&&j.reload()}return(e,a)=>{const c=Q("Button"),B=Q("ErrorMessage");return i(),U(sa,null,[n(Ue,null,la({"left-header":v(()=>[n(o(Ca),{items:b.value},{prefix:v(({item:s})=>[s.icon?(i(),d(he,{key:0,icon:s.icon,class:"mr-2 h-4"},null,8,["icon"])):m("",!0)]),_:1},8,["items"])]),_:2},[p.value?void 0:{name:"right-header",fn:v(()=>{var s,M;return[(s=o(t)._actions)!=null&&s.length?(i(),d(le,{key:0,actions:o(t)._actions},null,8,["actions"])):m("",!0),(M=o(t).actions)!=null&&M.length?(i(),d(le,{key:1,actions:o(t).actions},null,8,["actions"])):m("",!0),n(Me,{modelValue:o(j).data,"onUpdate:modelValue":a[0]||(a[0]=S=>o(j).data=S),doctype:"CRM Lead",docname:h.leadId},null,8,["modelValue","docname"]),l.value&&o(t).statuses?(i(),d(o(ue),{key:2,options:P.value,placement:"right"},{default:v(({open:S})=>[l.value.status?(i(),d(c,{key:0,label:l.value.status,iconRight:S?"chevron-up":"chevron-down"},{prefix:v(()=>[n(Te,{class:na(o(J)(l.value.status).color)},null,8,["class"])]),_:1},8,["label","iconRight"])):m("",!0)]),_:1},8,["options"])):m("",!0),n(c,{label:e.__("Convert to Deal"),variant:"solid",onClick:a[1]||(a[1]=S=>T.value=!0)},null,8,["label"])]}),key:"0"}]),1024),l.value.name?(i(),U("div",Fa,[n(o(Je),{modelValue:o(L),"onUpdate:modelValue":a[4]||(a[4]=s=>ie(L)?L.value=s:null),tabs:x.value,class:"flex flex-1 overflow-hidden flex-col [&_[role='tab']]:px-0 [&_[role='tablist']]:px-5 [&_[role='tablist']]:gap-7.5 [&_[role='tabpanel']:not([hidden])]:flex [&_[role='tabpanel']:not([hidden])]:grow"},{"tab-panel":v(()=>[n(Ie,{ref_key:"activities",ref:f,doctype:"CRM Lead",docname:h.leadId,tabs:x.value,reload:C.value,"onUpdate:reload":a[2]||(a[2]=s=>C.value=s),tabIndex:o(L),"onUpdate:tabIndex":a[3]||(a[3]=s=>ie(L)?L.value=s:null),onBeforeSave:ge,onAfterSave:Z},null,8,["docname","tabs","reload","tabIndex"])]),_:1},8,["modelValue","tabs"]),n(Ce,{class:"flex flex-col justify-between border-l",side:"right"},{default:v(()=>[u("div",{class:"flex h-[45px] cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:a[5]||(a[5]=s=>o(pa)(h.leadId))},E(e.__(h.leadId)),1),n(o(ka),{onSuccess:a[7]||(a[7]=s=>W("image",s.file_url)),validateFile:o(va)},{default:v(({openFileSelector:s,error:M})=>[u("div",Oa,[u("div",Na,[n(o(fa),{size:"3xl",class:"size-12",label:z.value,image:l.value.image},null,8,["label","image"]),(i(),d(ra(l.value.image?o(ue):"div"),ia(l.value.image?{options:[{icon:"upload",label:l.value.image?e.__("Change image"):e.__("Upload image"),onClick:s},{icon:"trash-2",label:e.__("Remove image"),onClick:()=>W("image","")}]}:{onClick:s},{class:"!absolute bottom-0 left-0 right-0"}),{default:v(()=>[u("div",ja,[n(ze,{class:"size-4 cursor-pointer text-white"})])]),_:1},16))]),u("div",Ba,[n(o(ua),{text:l.value.lead_name||e.__("Set first name")},{default:v(()=>[u("div",Pa,E(z.value),1)]),_:1},8,["text"]),u("div",Wa,[o(Qe)?(i(),d(c,{key:0,tooltip:e.__("Make a call"),icon:oe,onClick:()=>l.value.mobile_no?o(X)(l.value.mobile_no):o(q).error(e.__("No phone number set"))},null,8,["tooltip","onClick"])):m("",!0),n(c,{tooltip:e.__("Send an email"),icon:$e,onClick:S=>l.value.email?_e():o(q).error(e.__("No email set"))},null,8,["tooltip","onClick"]),n(c,{tooltip:e.__("Go to website"),icon:qe,onClick:S=>l.value.website?o(_a)(l.value.website):o(q).error(e.__("No website set"))},null,8,["tooltip","onClick"]),n(c,{tooltip:e.__("Attach a file"),icon:te,onClick:a[6]||(a[6]=S=>O.value=!0)},null,8,["tooltip"]),g.value?(i(),d(c,{key:1,tooltip:e.__("Delete"),variant:"subtle",theme:"red",icon:"trash-2",onClick:ae},null,8,["tooltip"])):m("",!0)]),n(B,{message:e.__(M)},null,8,["message"])])])]),_:1},8,["validateFile"]),l.value.sla_status?(i(),d(Ee,{key:0,modelValue:l.value,"onUpdate:modelValue":a[8]||(a[8]=s=>l.value=s),onUpdateField:W},null,8,["modelValue"])):m("",!0),o(Y).data?(i(),U("div",Qa,[n(Oe,{sections:o(Y).data,doctype:"CRM Lead",docname:h.leadId,onReload:o(Y).reload,onAfterFieldChange:Z},null,8,["sections","docname","onReload"])])):m("",!0)]),_:1})])):p.value?(i(),d(ye,{key:1,errorTitle:p.value,errorMessage:D.value},null,8,["errorTitle","errorMessage"])):m("",!0),T.value?(i(),d(Ua,{key:2,modelValue:T.value,"onUpdate:modelValue":a[9]||(a[9]=s=>T.value=s),lead:l.value},null,8,["modelValue","lead"])):m("",!0),n(xe,{modelValue:O.value,"onUpdate:modelValue":a[10]||(a[10]=s=>O.value=s),doctype:"CRM Lead",docname:h.leadId,onAfter:a[11]||(a[11]=()=>{var s,M;(M=(s=f.value)==null?void 0:s.all_activities)==null||M.reload(),o(ve)("attachments")})},null,8,["modelValue","docname"]),_.value?(i(),d(be,{key:3,modelValue:_.value,"onUpdate:modelValue":a[12]||(a[12]=s=>_.value=s),doctype:"CRM Lead",docname:h.leadId,name:"Leads"},null,8,["modelValue","docname"])):m("",!0)],64)}}};export{Ot as default};
//# sourceMappingURL=Lead-0019cac3.js.map
