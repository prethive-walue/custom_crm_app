import{j as Z,L as ce,M as _e,a3 as Se,x as N,T as ve,a4 as $e,y as te,b as a,c as m,g as B,a5 as Ie,A as P,d as k,w as q,u as U,e,t as E,I as Me,a6 as Ve,n as J,B as oe,N as Fe,a0 as me,a1 as X,l as T,$ as xe,a7 as W,Q as Y,a8 as G,R as fe,F as K,f as Q,a9 as ne,aa as be,a as he,ab as Te,E as le,ac as Re,ad as Ee,ae as Ne,Y as ye,J as De,af as Le,W as ke,ag as Oe}from"./index-2806a214.js";import{u as Ue}from"./pageMeta-ec5fe886.js";import{_ as je}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-3225a656.js";import{d as ze,D as Pe}from"./dayjs-40d38903.js";import{L as Be}from"./plus-ad0e20b1.js";import{T as qe}from"./TabButtons-1c70c2d8.js";import{F as Ae}from"./fileUploadHandler-0b2042a3.js";import"./description-6463fb61.js";const Je={class:"font-medium"},He=Z({inheritAttrs:!1,__name:"Link",props:ce({doctype:{},variant:{default:"subtle"},label:{default:""},placeholder:{},filters:{default:()=>({})},required:{type:Boolean},allowCreate:{type:Boolean}},{modelValue:{default:""},modelModifiers:{}}),emits:ce(["create"],["update:modelValue"]),setup(D,{emit:M}){const o=D,s=_e(D,"modelValue"),d=M,_=Se(),f=N(()=>Object.fromEntries(Object.entries(_).filter(([t])=>t!=="class"&&t!=="style"))),y=ve({url:"frappe.desk.search.search_link",params:{doctype:o.doctype,txt:"",filters:o.filters},method:"POST",resourceFetcher:$e,transform:t=>t.map(u=>({label:u.label||u.value,value:u.value}))}),R={type:"custom",key:"create_new",label:"Create New",slotName:"create-new",condition:()=>!0,onClick:({searchTerm:t})=>d("create",t)},L=N(()=>{const t=y.data||[];return o.allowCreate?[...t,R]:t}),j=(t="")=>{y.update({params:{txt:t,doctype:o.doctype,filters:o.filters}}),y.reload()},g=Fe(t=>{j(t||"")},300);return te([()=>o.doctype,()=>o.filters],()=>j(""),{immediate:!0,deep:!0}),(t,u)=>(a(),m("div",{class:J(["flex flex-col gap-1.5",U(_).class]),style:oe(U(_).style)},[t.label?(a(),B(Ie,{key:0,label:t.label,size:"sm",required:t.required},null,8,["label","required"])):P("",!0),k(U(Ve),Me({modelValue:s.value,"onUpdate:modelValue":u[0]||(u[0]=n=>s.value=n),placeholder:t.placeholder||`Select ${t.doctype}`,options:L.value,onInput:U(g),onFocus:u[1]||(u[1]=()=>j("")),"open-on-focus":!0},f.value,{variant:o.variant}),{"create-new":q(({searchTerm:n})=>[k(U(Be),{class:"size-4 mr-2"}),e("span",Je," Create new "+E(t.doctype),1)]),_:1},16,["modelValue","placeholder","options","onInput","variant"])],6))}}),ie=D=>({Pending:"orange",Success:"green","Partial Success":"orange",Error:"red","Timed Out":"orange"})[D]||"gray",re=["Section Break","Column Break","Tab Break","HTML","Table","Table MultiSelect","Button","Image","Fold","Heading"],we=(D,M,o)=>{let s="";return o.filter(_=>_.name==M)[0].fields.forEach(_=>{_.options==D&&(s=_.fieldname)}),s},Ce=(D,M,o)=>me("frappe.core.doctype.data_import.data_import.get_preview_from_template",{data_import:D,import_file:M,google_sheets_url:o}).catch(s=>{var d;X.error(((d=s.messages)==null?void 0:d[0])||s),console.error("Error fetching preview data:",s)}),We={class:"flex min-h-0 flex-col text-base py-5 w-[90%] lg:w-[700px] mx-auto"},Ge={class:"flex items-center justify-between"},Ke={class:"flex items-center space-x-2 my-5"},Qe={key:0,class:"overflow-y-scroll"},Ye={class:"divide-y"},Xe=["onClick"],Ze={class:"space-y-1"},et={class:"text-ink-gray-7"},tt={class:"text-ink-gray-5"},at={class:"my-5 flex justify-center"},st={key:1,class:"text-sm italic text-ink-gray-5 mt-5"},lt=Z({__name:"DataImportList",props:{dataImports:{}},emits:["updateStep"],setup(D,{emit:M}){const o=T(""),s=T("All"),d=T(!1),_=T(null),f=xe(),y=D,R=N(()=>["All","Pending","Success","Partial Success","Error","Timed Out"].map(t=>({label:t,value:t})));te([o,s],([g,t])=>{y.dataImports.update({filters:[g?[["name","like",`%${g}%`]]:[],t!=="All"?[["status","=",t]]:[]].flat()}),y.dataImports.reload()});const L=g=>{y.dataImports.insert.submit({reference_doctype:_.value,import_type:"Insert New Records",mute_emails:!0,status:"Pending"},{onSuccess(t){f.replace({name:"DataImport",params:{importName:t.name}}),g()},onError(t){var u;console.error(t),X.error(((u=t.messages)==null?void 0:u[0])||t)}})},j=g=>{f.replace({name:"DataImport",params:{importName:g}})};return(g,t)=>{var u;return a(),m("div",We,[e("div",Ge,[t[7]||(t[7]=e("div",null,[e("div",{class:"text-xl font-semibold mb-1 text-ink-gray-9"}," Data Import "),e("div",{class:"text-ink-gray-6 leading-5"}," Import data into your system using CSV files. ")],-1)),k(G,{variant:"solid",onClick:t[0]||(t[0]=n=>d.value=!0)},{prefix:q(()=>[k(W,{name:"plus",class:"size-4 stroke-1.5"})]),default:q(()=>[t[6]||(t[6]=Y(" Import ",-1))]),_:1})]),e("div",Ke,[k(fe,{modelValue:o.value,"onUpdate:modelValue":t[1]||(t[1]=n=>o.value=n),placeholder:"Search imported files",type:"text",class:"flex-1"},null,8,["modelValue"]),k(fe,{modelValue:s.value,"onUpdate:modelValue":t[2]||(t[2]=n=>s.value=n),type:"select",options:R.value},null,8,["modelValue","options"])]),(u=g.dataImports.data)!=null&&u.length?(a(),m("div",Qe,[e("div",Ye,[t[8]||(t[8]=e("div",{class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center text-sm text-ink-gray-5 py-1.5 mx-2 my-0.5 px-1"},[e("div",null," Name "),e("div",{class:"pl-1"}," Status ")],-1)),(a(!0),m(K,null,Q(g.dataImports.data,n=>(a(),m("div",{onClick:()=>j(n.name),class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center cursor-pointer py-2.5 px-1 mx-2"},[e("div",Ze,[e("div",et,E(n.reference_doctype),1),e("div",tt,E(U(ze)(n.creation).fromNow()),1)]),k(ne,{label:n.status,theme:U(ie)(n.status),class:"w-fit"},null,8,["label","theme"])],8,Xe))),256))]),e("div",at,[y.dataImports.hasNextPage?(a(),B(G,{key:0,onClick:t[3]||(t[3]=n=>y.dataImports.next())},{prefix:q(()=>[k(W,{name:"refresh-cw",class:"size-4 stroke-1.5"})]),default:q(()=>[t[9]||(t[9]=Y(" Load More ",-1))]),_:1})):P("",!0)])])):(a(),m("div",st," No data imports found. ")),k(be,{modelValue:d.value,"onUpdate:modelValue":t[5]||(t[5]=n=>d.value=n),options:{title:"New Data Import",actions:[{label:"Continue",variant:"solid",onClick({close:n}){L(n)}}]}},{"body-content":q(()=>[e("div",null,[k(He,{modelValue:_.value,"onUpdate:modelValue":t[4]||(t[4]=n=>_.value=n),doctype:"DocType",filters:{allow_import:1},label:"Choose a Document Type to import"},null,8,["modelValue"])])]),_:1},8,["modelValue","options"])])}}}),ot={class:"flex items-center space-x-3 lg:space-x-10 text-xs lg:text-base"},ge=Z({__name:"ImportSteps",props:{data:{},step:{}},emits:["updateStep"],setup(D,{emit:M}){const o=M,s=D,d=N(()=>s.step==="upload"),_=N(()=>{var t,u;return((t=s.data)==null?void 0:t.import_file)||((u=s.data)==null?void 0:u.google_sheets_url)}),f=N(()=>s.step==="map"),y=N(()=>{var t;return s.data&&((t=s.data)==null?void 0:t.template_options)&&JSON.parse(s.data.template_options).column_to_field_map}),R=N(()=>s.step==="preview"),L=N(()=>{var t;return((t=s.data)==null?void 0:t.status)==="Success"}),j=()=>{_.value&&o("updateStep","map",{...s.data})},g=()=>{_.value&&o("updateStep","preview",{...s.data})};return(t,u)=>(a(),m("div",ot,[e("div",{class:J(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5 cursor-pointer",{"text-ink-gray-9 font-semibold":d.value}]),onClick:u[0]||(u[0]=n=>o("updateStep","upload",{...t.data}))},[_.value?(a(),B(W,{key:0,name:"check",class:J(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":d.value}])},null,8,["class"])):(a(),m("div",{key:1,class:J(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":d.value}])},[...u[3]||(u[3]=[e("span",null," 1 ",-1)])],2)),u[4]||(u[4]=e("div",null," Upload File ",-1))],2),e("div",{class:J(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":f.value,"cursor-pointer":_.value}]),onClick:u[1]||(u[1]=n=>j())},[y.value?(a(),B(W,{key:0,name:"check",class:J(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":f.value}])},null,8,["class"])):(a(),m("div",{key:1,class:J(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":f.value}])},[...u[5]||(u[5]=[e("span",null," 2 ",-1)])],2)),u[6]||(u[6]=e("div",null," Map Data ",-1))],2),e("div",{class:J(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":R.value,"cursor-pointer":_.value}]),onClick:u[2]||(u[2]=n=>g())},[L.value?(a(),B(W,{key:0,name:"check",class:J(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":R.value}])},null,8,["class"])):(a(),m("div",{key:1,class:J(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":R.value}])},[...u[7]||(u[7]=[e("span",null," 3 ",-1)])],2)),u[8]||(u[8]=e("div",null," Review & Import ",-1))],2)]))}}),rt={class:"w-[85%] lg:w-[700px] mx-auto py-12 space-y-8 text-base"},nt={class:"flex justify-between"},it={class:"space-y-2"},dt={class:"text-lg font-semibold text-ink-gray-9"},ut={class:"flex flex-col lg:flex-row space-y-2 lg:space-x-2 lg:space-y-0"},pt={key:0,class:"border rounded-md space-y-8"},ct={class:"grid grid-cols-2 py-2 px-4 gap-y-8"},mt={class:"text-ink-gray-7"},ft=Z({__name:"MappingStep",props:{dataImports:{},data:{},fields:{}},emits:["updateStep"],setup(D,{emit:M}){const o=T(null),s=M,d=T({}),_=T(!1),f=D;he(async()=>{o.value=await Ce(f.data.name,f.data.import_file,f.data.google_sheets_url),y()});const y=()=>{var V,S,I;const n={};let l=[];(V=f.data)!=null&&V.template_options&&(l=(I=JSON.parse((S=f.data)==null?void 0:S.template_options))==null?void 0:I.column_to_field_map),Object.keys(l).length>0&&(_.value=!0),j.value.forEach((c,r)=>{l&&l[r]?n[c]=R(l[r]):n[c]=c}),d.value=n},R=n=>{const l=g.value.find(V=>V.value==n);return l?l.label:n},L=(n,l)=>{var I,c;if(!l)return;_.value=!0;let V=(I=f.data)!=null&&I.template_options?JSON.parse((c=f.data)==null?void 0:c.template_options):{},S=V.column_to_field_map||{};S[n-1]=l.value,f.dataImports.setValue.submit({...f.data,template_options:JSON.stringify({...V,column_to_field_map:S})},{onSuccess:r=>{s("updateStep","map",{...r}),le(()=>{y()})},onError:r=>{var h;X.error(((h=r.messages)==null?void 0:h[0])||r),console.error("Error updating column mappings:",r)}})},j=N(()=>{var l;const n=[];return(l=o.value)==null||l.columns.forEach(V=>{V.header_title!="Sr. No"&&n.push(V.header_title)}),n}),g=N(()=>{var V;const n=f.data.reference_doctype;return(((V=f.fields.data)==null?void 0:V.docs)||[]).map(S=>{const I=S.name===n,c=S.fields.filter(r=>!re.includes(r.fieldtype)).map(r=>({value:r.fieldname,label:I?r.label:`${r.label} (${u(n,S.name)})`}));return[{value:"name",label:"ID"},...c]}).flat()}),t=()=>{var l,V;let n=(l=f.data)!=null&&l.template_options?JSON.parse((V=f.data)==null?void 0:V.template_options):{};f.dataImports.setValue.submit({...f.data,template_options:JSON.stringify({...n,column_to_field_map:{}})},{onSuccess:S=>{s("updateStep","map",{...S}),le(()=>{y()})},onError:S=>{var I;X.error(((I=S.messages)==null?void 0:I[0])||S),console.error("Error resetting column mappings:",S)}})},u=(n,l)=>{var I,c;let S=(((c=(I=f.fields.data)==null?void 0:I.docs.find(r=>r.name==n))==null?void 0:c.fields)||[]).filter(r=>r.options==l)[0];return(S==null?void 0:S.label)||l};return(n,l)=>{var V,S;return a(),m("div",rt,[e("div",nt,[e("div",it,[e("div",dt,[l[1]||(l[1]=e("span",null," Map Data ",-1)),(V=n.data)!=null&&V.status?(a(),B(ne,{key:0,theme:U(ie)((S=n.data)==null?void 0:S.status)},{default:q(()=>{var I;return[Y(E((I=n.data)==null?void 0:I.status),1)]}),_:1},8,["theme"])):P("",!0)]),l[2]||(l[2]=e("div",{class:"leading-5 text-ink-gray-7"}," Change the mapping of columns from your file to fields in the system ",-1))]),e("div",ut,[_.value?(a(),B(G,{key:0,label:"Reset Mapping",onClick:t})):P("",!0),k(G,{label:"Continue",variant:"solid",onClick:l[0]||(l[0]=I=>n.$emit("updateStep","preview"))})])]),Object.keys(d.value).length?(a(),m("div",pt,[l[3]||(l[3]=e("div",{class:"grid grid-cols-2 text-ink-gray-5 border-b py-2 px-4"},[e("div",null," Fields in File "),e("div",null," Fields in System ")],-1)),e("div",ct,[(a(!0),m(K,null,Q(j.value.length,I=>(a(),m(K,{key:I},[e("div",mt,E(j.value[I-1]),1),k(Te,{"model-value":d.value[j.value[I-1]],options:g.value,placeholder:"Select field","onUpdate:modelValue":c=>L(I,c)},null,8,["model-value","options","onUpdate:modelValue"])],64))),128))])])):P("",!0)])}}}),vt={class:"text-base h-full flex flex-col w-[90%] lg:w-[700px] mx-auto py-12 space-y-10"},yt={class:"flex flex-col space-y-1"},gt={class:"flex items-center justify-between text-ink-gray-7"},_t={class:"flex items-center space-x-2 text-lg font-semibold text-ink-gray-9"},xt={key:0,class:"space-y-2"},bt={class:"border rounded-md bg-surface-gray-2 p-4 space-y-4 text-sm text-ink-gray-7"},ht={class:"grid grid-cols-[40%,10%,40%] lg:grid-cols-3 space-x-3 items-center"},kt={class:""},wt={class:"flex justify-end"},Ct={key:1,class:"space-y-2"},St={class:"rounded-md bg-surface-amber-2 p-2 space-y-2 text-xs"},$t={class:"flex items-center space-x-2"},It=["innerHTML"],Mt={key:2,class:"border rounded-md overflow-x-auto"},Vt={class:"divide-y"},Ft={class:"rounded-t-md"},Tt={class:"bg-surface-white divide-y divide-surface-gray-2"},Rt={class:"leading-5 text-sm"},Et={key:3,class:"space-y-4"},Nt={key:0,class:"border rounded-md overflow-x-auto"},Dt={class:"table-fixed w-full divide-y"},Lt={class:"bg-surface-white divide-y divide-surface-gray-2"},Ot={class:"px-3 py-2 text-sm text-ink-gray-7 border-r"},Ut={class:"flex items-center justify-center space-x-2"},jt={key:0,class:"size-1.5 bg-surface-green-3 rounded"},zt={key:1,class:"size-1.5 bg-surface-red-5 rounded"},Pt={class:"px-3 py-2 text-sm text-ink-gray-7 w-full"},Bt=["innerHTML"],qt={key:1},At={key:2},Jt=["onClick"],Ht={class:"px-3 py-2 text-ink-gray-5 float-right invisible group-hover:visible"},Wt={class:"w-[500px] p-2 text-xs leading-5 font-mono"},Gt={key:1,class:"text-ink-gray-5 text-sm"},Kt=Z({__name:"PreviewStep",props:{dataImports:{},data:{},fields:{},doctypeMap:{}},emits:["updateStep"],setup(D,{emit:M}){const o=T(null),s=M,d=T([]),_=T([]),f=T("all"),y=D;he(async()=>{var x;Re().on("data_import_refresh",w=>{R(w.data_import)}),(x=y.data)!=null&&x.name&&(o.value=await Ce(y.data.name,y.data.import_file,y.data.google_sheets_url),y.data.status!="Pending"&&n())});const R=v=>{v==y.data.name&&le(()=>{y.dataImports.reload(),le(async()=>{var w;let x=(w=y.dataImports.data)==null?void 0:w.find(A=>A.name===y.data.name);s("updateStep","preview",{...x}),n()})})},L=N(()=>{var x;const v=[];return(x=o.value)==null||x.columns.forEach((w,A)=>{let b="left",z="300px";A==0?(w.header_title="No",b="center",z="60px"):w.header_title=="ID"&&(z="150px"),v.push({key:w.header_title,label:w.header_title,width:z,align:b})}),v}),j=N(()=>{var x;const v=[];return(x=o.value)==null||x.data.forEach(w=>{const A={};Object.keys(w).forEach((b,z)=>{let p=g(z),i=t(z);p=="No"?A[p]=w[b]-1:i?A[p]=w[i]:A[p]=w[b]}),v.push(A)}),v}),g=v=>{var x,w;return((w=(x=o.value)==null?void 0:x.columns[v])==null?void 0:w.header_title)||`Column ${v+1}`},t=v=>{var b,z,p,i,F,C,O;if(!((z=(b=o.value)==null?void 0:b.columns[v])==null?void 0:z.map_to_field))return null;let w=(F=(i=(p=o.value)==null?void 0:p.columns[v])==null?void 0:i.df)==null?void 0:F.label;return(O=(C=o.value)==null?void 0:C.columns.filter(ae=>ae.header_title==w)[0])==null?void 0:O.column_number},u=()=>{me("frappe.core.doctype.data_import.data_import.form_start_import",{data_import:y.data.name})},n=()=>{me("frappe.core.doctype.data_import.data_import.get_import_logs",{data_import:y.data.name}).then(v=>{d.value=v,_.value=v})},l=()=>{f.value=="all"?_.value=d.value:f.value=="successful"?_.value=d.value.filter(v=>v.success):f.value=="failed"&&(_.value=d.value.filter(v=>!v.success))};te(f,()=>{l()});const V=N(()=>d.value.length?d.value.filter(v=>v.success).length:0),S=N(()=>d.value.length?d.value.filter(v=>!v.success).length:0),I=N(()=>S.value==0?"bg-surface-green-2 text-ink-green-3":V.value==0?"bg-surface-red-2 text-ink-red-3":"bg-surface-amber-2 text-ink-amber-3"),c=N(()=>{var x,w;let v=[];return(w=(x=o.value)==null?void 0:x.warnings)!=null&&w.length?(o.value.warnings.forEach(A=>{if(A.type=="info"){const b=/<strong>(.*?)<\/strong>/g;let z;const p=[];for(;(z=b.exec(A.message))!==null;)p.push(z[1]);v.push(p)}}),v):[]}),r=N(()=>{var v,x;return((x=(v=o.value)==null?void 0:v.warnings)==null?void 0:x.filter(w=>w.type!="info"))||[]}),h=N(()=>{var v;return(v=y.doctypeMap[y.data.reference_doctype])==null?void 0:v.listRoute}),$=()=>{h.value&&(window.location.href=h.value)},ee=N(()=>{var v;return(v=y.doctypeMap[y.data.reference_doctype])==null?void 0:v.pageRoute}),de=v=>{ee.value&&(window.location.href=ee.value.replace("docname",v))},ue=N(()=>[{label:"All",value:"all"},{label:"Successful",value:"successful"},{label:"Failed",value:"failed"}]),se=v=>{var x,w;return(w=(x=JSON.parse(v.messages))==null?void 0:x[0])==null?void 0:w.message};return(v,x)=>{var w,A;return a(),m("div",vt,[e("div",yt,[e("div",gt,[e("div",_t,[x[2]||(x[2]=e("span",null," Review and Import ",-1)),k(ne,{theme:U(ie)(v.data.status)},{default:q(()=>[Y(E(v.data.status),1)]),_:1},8,["theme"])]),v.data.status!="Success"?(a(),B(G,{key:0,label:v.data.status!="Pending"?"Retry":"Import",variant:"solid",onClick:u},null,8,["label"])):h.value?(a(),B(G,{key:1,label:"Done",onClick:x[0]||(x[0]=b=>$())})):P("",!0)]),x[3]||(x[3]=e("div",{class:"leading-5 text-ink-gray-7"}," Verify the data before starting the import process ",-1))]),c.value.length?(a(),m("div",xt,[x[4]||(x[4]=e("div",{class:"text-ink-gray-5 text-sm"}," Column Mapping ",-1)),e("div",bt,[(a(!0),m(K,null,Q(c.value,b=>(a(),m("div",ht,[e("div",kt,E(b[0]),1),e("div",wt,[k(W,{name:"arrow-right",class:"inline size-4 text-ink-gray-5"})]),e("div",null,E(b[1]),1)]))),256))])])):P("",!0),r.value.length?(a(),m("div",Ct,[x[5]||(x[5]=e("div",{class:"text-ink-gray-5 text-sm"}," Warnings ",-1)),e("div",St,[(a(!0),m(K,null,Q(r.value,b=>(a(),m("div",$t,[k(W,{name:"alert-circle",class:"size-3 text-ink-amber-3"}),e("div",{innerHTML:b.message,class:"text-ink-amber-3"},null,8,It)]))),256))])])):P("",!0),(A=(w=o.value)==null?void 0:w.data)!=null&&A.length?(a(),m("div",Mt,[e("table",Vt,[e("thead",Ft,[e("tr",null,[(a(!0),m(K,null,Q(L.value,b=>(a(),m("th",{key:b.key,style:oe({minWidth:b.width,textAlign:b.align}),class:J(["p-2 text-left text-sm text-ink-gray-5",{"border-r":b.key!=L.value[L.value.length-1].key,"w-full":b.key==L.value[L.value.length-1].key}])},E(b.label),7))),128))])]),e("tbody",Tt,[(a(!0),m(K,null,Q(j.value,(b,z)=>(a(),m("tr",{key:z},[(a(!0),m(K,null,Q(L.value,p=>(a(),m("td",{key:p.key,style:oe({minWidth:p.width,textAlign:p.align}),class:J(["px-3 py-2 text-sm text-ink-gray-7 align-top",{"border-r":p.key!=L.value[L.value.length-1].key}])},[e("div",Rt,E(b[p.key]),1)],6))),128))]))),128))])])])):P("",!0),v.data.status!="Pending"&&d.value.length?(a(),m("div",Et,[x[8]||(x[8]=e("div",{class:"font-semibold text-ink-gray-9"}," Import Logs ",-1)),e("div",{class:J(["rounded-md p-2",I.value])},E(V.value)+" "+E(V.value==1?"row":"rows")+" imported successfully, "+E(S.value)+" "+E(S.value==1?"row":"rows")+" failed. ",3),k(qe,{buttons:ue.value,modelValue:f.value,"onUpdate:modelValue":x[1]||(x[1]=b=>f.value=b),class:"w-fit"},null,8,["buttons","modelValue"]),_.value.length?(a(),m("div",Nt,[e("table",Dt,[x[7]||(x[7]=e("thead",{class:"rounded-t-md"},[e("tr",null,[e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-20 border-r text-center"}," Row no. "),e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-[80%]"}," Message ")])],-1)),e("tbody",Lt,[(a(!0),m(K,null,Q(_.value,(b,z)=>(a(),m("tr",{key:z,class:"group"},[e("td",Ot,[e("div",Ut,[b.success?(a(),m("div",jt)):(a(),m("div",zt)),e("div",null,E(JSON.parse(b.row_indexes)[0]-1),1)])]),e("td",Pt,[se(b)?(a(),m("span",{key:0,innerHTML:se(b)},null,8,Bt)):!se(b)&&!b.success?(a(),m("span",qt," Failed to import ")):b.success?(a(),m("span",At,[x[6]||(x[6]=Y(" Successfully imported ",-1)),e("span",{onClick:p=>de(b.docname),class:J({"cursor-pointer underline":ee.value})},E(b.docname),11,Jt)])):P("",!0)]),e("td",Ht,[b.exception?(a(),B(Ee,{key:0,trigger:"hover",placement:"left-start"},{target:q(()=>[k(W,{name:"info",class:"size-4"})]),"body-main":q(()=>[e("div",Wt,E(b.exception),1)]),_:2},1024)):P("",!0)])]))),128))])])])):(a(),m("div",Gt," No logs to display. "))])):P("",!0)])}}}),Qt={class:"text-base space-y-5"},Yt={class:"grid grid-cols-2 gap-5"},Xt={class:"border-t"},Zt={class:"space-x-2 mt-2 mb-5"},ea={class:"space-y-8"},ta={class:"text-ink-gray-5"},aa={class:"grid grid-cols-2 gap-5"},sa=["for"],la={class:"flex justify-end space-x-2"},oa=Z({__name:"TemplateModal",props:ce({doctype:{}},{modelValue:{type:Boolean,required:!0,default:!1},modelModifiers:{}}),emits:["update:modelValue"],setup(D){const M=_e(D,"modelValue"),o=T("CSV"),s=T("Blank Template"),d=T({}),_=T(null),f=D,y=ve({url:"frappe.desk.form.load.getdoctype",params:{doctype:f.doctype,with_parent:1},auto:!0,transform(c){return _.value=c.docs,R(c)}}),R=c=>{let r={};return L(c.docs,r),j(r),g(r),r},L=(c,r)=>{c.forEach(h=>{r[h.name]=h.fields.filter($=>!re.includes($.fieldtype)).map($=>({fieldname:$.fieldname,label:$.label,reqd:$.reqd,disabled:!!(h.name==f.doctype&&$.reqd)}))})},j=c=>{Object.keys(c).forEach(r=>{c[r].unshift({fieldname:"name",label:"ID",reqd:1})})},g=c=>{Object.keys(c).forEach(r=>{d.value[r]||(d.value[r]={},r==f.doctype&&c[r].forEach(h=>{h.reqd&&(d.value[r][h.fieldname]=!0)}))})},t=()=>{let c=f.doctype,r=n(),h=l(),$=s.value=="5 Records"?5:"";return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(c)}
        &export_fields=${encodeURIComponent(JSON.stringify(r))}
        &export_records=${encodeURIComponent(h)}
        &file_type=${encodeURIComponent(o.value)}
        &export_page_length=${$}`.replace(/\s+/g,"")},u=async()=>{let c=t();const h=await(await fetch(c)).blob(),$=document.createElement("a");$.href=URL.createObjectURL(h),$.download=f.doctype+(o.value==="CSV"?".csv":".xlsx"),document.body.appendChild($),$.click(),document.body.removeChild($)},n=()=>{let c={};return Object.keys(d.value).forEach(r=>{let h=r==f.doctype?r:we(r,f.doctype,_.value);c[h]=Object.keys(d.value[r]).filter($=>d.value[r][$])}),c},l=()=>s.value=="Blank Template"?"blank_template":s.value=="5 Records"?"5_records":"all",V=()=>{Object.keys(y.data).forEach(c=>{y.data[c].forEach(r=>{d.value[c]||(d.value[c]={}),d.value[c][r.fieldname]=!0})})},S=()=>{Object.keys(y.data).forEach(c=>{y.data[c].forEach(r=>{d.value[c][r.fieldname]=!!r.reqd})})},I=()=>{Object.keys(y.data).forEach(c=>{y.data[c].forEach(r=>{d.value[c][r.fieldname]=!1})})};return(c,r)=>(a(),B(be,{modelValue:M.value,"onUpdate:modelValue":r[1]||(r[1]=h=>M.value=h),options:{title:"Export Data",size:"2xl"}},{"body-content":q(()=>[e("div",Qt,[e("div",Yt,[k(fe,{label:"File Type",modelValue:o.value,"onUpdate:modelValue":r[0]||(r[0]=h=>o.value=h),options:["Excel","CSV"],type:"select"},null,8,["modelValue"])]),e("div",Xt,[r[2]||(r[2]=e("p",{class:"mt-2 text-ink-gray-5"}," Select the fields you want to include in the template. ",-1)),e("div",Zt,[k(G,{label:"Select All",onClick:V}),k(G,{label:"Select Mandatory Fields",onClick:S}),k(G,{label:"Unselect All",onClick:I})]),e("div",ea,[(a(!0),m(K,null,Q(Object.keys(U(y).data),h=>(a(),m("div",{key:h,class:"flex flex-col space-y-2"},[e("div",ta,E(h),1),e("div",aa,[(a(!0),m(K,null,Q(U(y).data[h],$=>(a(),m("div",{key:$.fieldname,class:"flex items-center space-x-2"},[k(Ne,{id:`checkbox-${h}-${$.fieldname}`,checked:d.value[h][$.fieldname],onChange:ee=>d.value[h][$.fieldname]=ee.target.checked},null,8,["id","checked","onChange"]),e("label",{for:`checkbox-${h}-${$.fieldname}`,class:J({"text-ink-red-3":$.reqd})},E($.label||$.fieldname),11,sa)]))),128))])]))),128))])])])]),actions:q(({close:h})=>[e("div",la,[k(G,{label:"Export",variant:"solid",onClick:u}),k(G,{label:"Cancel",onClick:h},null,8,["onClick"])])]),_:1},8,["modelValue"]))}}),ra={class:"text-base h-full flex flex-col w-[85%] lg:w-[700px] mx-auto pt-12 space-y-8"},na={class:"flex flex-col space-y-1 text-ink-gray-7"},ia={class:"flex items-center justify-between"},da={class:"flex items-center space-x-2 text-xl font-semibold text-ink-gray-9"},ua={class:"space-y-4"},pa={key:0,class:"w-4/5 lg:w-2/5 text-center"},ca={key:1,class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2"},ma={class:"space-y-2"},fa={class:"font-medium"},va={class:"text-ink-gray-6"},ya={class:"w-full bg-surface-gray-1 h-1 rounded-full mt-3"},ga={key:1,class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},_a={class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2 flex items-center justify-between items-center"},xa={class:"space-y-2"},ba={class:"font-medium leading-5 text-ink-gray-9"},ha={key:0,class:"text-ink-gray-6"},ka={key:2,class:"flex flex-col h-[300px] p-4 border border-dashed border-outline-gray-3 rounded-md"},wa={class:"flex items-center space-x-2 text-ink-gray-7"},Ca={class:"flex-1 flex flex-col items-center justify-center w-[95%] lg:w-[400px] mx-auto space-y-3"},Sa={class:"flex justify-end"},$a=Z({__name:"UploadStep",props:{dataImports:{},doctype:{},fields:{},data:{}},emits:["updateStep"],setup(D,{emit:M}){const o=M,s=T(null),d=T(""),_=T(!1),f=T(null),y=T(0),R=T(0),L=T(!1),j=T(null),g=T(!0),t=T(!1),u=T(!1),n=xe(),l=D,V=N(()=>R.value===0?0:Math.floor(y.value/R.value*100)),S=p=>{var C,O;const i=(C=p.target)==null?void 0:C.files,F=(O=p.dataTransfer)==null?void 0:O.files;return(i==null?void 0:i[0])||(F==null?void 0:F[0])||null},I=p=>{const i=S(p);if(!i)return;if(i.type!=="text/csv"){X.error("Please upload a valid CSV file."),console.error("Please upload a valid CSV file.");return}f.value=i;const F=new Ae;F.on("start",()=>{_.value=!0}),F.on("progress",C=>{y.value=C.uploaded,R.value=C.total}),F.on("error",C=>{_.value=!1,X.error(C),console.error("File upload error:",C)}),F.on("finish",()=>{_.value=!1}),F.upload(i,{}).then(C=>{s.value=C}).catch(C=>{console.error("File upload error:",C)})},c=()=>{var p;(p=l.data)!=null&&p.name?h():r()},r=()=>{var p;l.dataImports.insert.submit({reference_doctype:l.doctype,import_type:"Insert New Records",mute_emails:!0,status:"Pending",google_sheets_url:d.value.trim(),import_file:(p=s.value)==null?void 0:p.file_url},{onSuccess(i){n.replace({name:"DataImport",params:{importName:i.name},query:{step:"map"}})},onError(i){var F;X.error(((F=i.messages)==null?void 0:F[0])||i),console.error("Error creating data import:",i)}})},h=()=>{l.data&&l.dataImports.setValue.submit({...l.data,google_sheets_url:d.value.trim(),import_file:s.value?s.value.file_url:""},{onSuccess(p){le(()=>{s.value||d.value.trim().length?o("updateStep","map",p):o("updateStep","upload",p)})},onError(p){var i;X.error(((i=p.messages)==null?void 0:i[0])||p,{duration:1e3}),console.error("Error updating data import:",p)}})},$=async p=>{let i=ee(p);const C=await(await fetch(i)).blob(),O=document.createElement("a");O.href=URL.createObjectURL(C),O.download=l.doctype+".csv",document.body.appendChild(O),O.click(),document.body.removeChild(O)},ee=p=>{var F,C;if(!l.doctype&&!((F=l.data)!=null&&F.reference_doctype))return"";let i=de(p);return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(l.doctype||((C=l.data)==null?void 0:C.reference_doctype))}
        &export_fields=${encodeURIComponent(JSON.stringify(i))}
        &export_records=blank_template
        &file_type=CSV`.replace(/\s+/g,"")},de=p=>p=="mandatory"?ue():se(),ue=()=>{var F,C;let i=((F=l.fields.data)==null?void 0:F.docs.find(O=>O.name==l.doctype)).fields.filter(O=>!re.includes(O.fieldtype)&&O.reqd).map(O=>O.fieldname);return i.unshift("name"),{[l.doctype||((C=l.data)==null?void 0:C.reference_doctype)]:i}},se=()=>{var F;let p={},i=((F=l.fields.data)==null?void 0:F.docs)||[];return i.forEach(C=>{var H;let O=C.fields.filter(pe=>!re.includes(pe.fieldtype)).map(pe=>pe.fieldname);O.unshift("name");let ae=C.name==l.doctype?C.name:we(C.name,l.doctype||((H=l.data)==null?void 0:H.reference_doctype),i);p[ae]=O}),p},v=()=>{var p;(p=j.value)==null||p.click()},x=()=>{g.value=!1,u.value=!1,t.value=!0},w=()=>{g.value=!0,u.value=!1,t.value=!1},A=N(()=>!s.value&&!d.value.trim().length);te(()=>l.data,()=>{l.data&&(l.data.import_file?s.value=l.data.import_file:l.data.google_sheets_url&&(x(),d.value=l.data.google_sheets_url))},{immediate:!0}),te([s,d],()=>{(!s.value||!d.value.trim().length)&&h()});const b=()=>{s.value=null},z=p=>(p/1024).toFixed(2)+" KB";return(p,i)=>{var F,C,O,ae;return a(),m("div",ra,[e("div",na,[e("div",ia,[e("div",da,[i[5]||(i[5]=e("span",null," Choose Import ",-1)),(F=p.data)!=null&&F.status?(a(),B(ne,{key:0,theme:U(ie)((C=p.data)==null?void 0:C.status)},{default:q(()=>{var H;return[Y(E((H=p.data)==null?void 0:H.status),1)]}),_:1},8,["theme"])):P("",!0)]),k(G,{variant:"solid",onClick:c,disabled:A.value},{default:q(()=>[...i[6]||(i[6]=[Y(" Continue ",-1)])]),_:1},8,["disabled"])]),i[7]||(i[7]=e("div",{class:"leading-5"}," Import data into your system using CSV files or Google Sheets. ",-1))]),e("div",ua,[g.value&&!s.value?(a(),m("div",{key:0,onDragover:i[1]||(i[1]=ye(()=>{},["prevent"])),onDrop:i[2]||(i[2]=ye(H=>I(H),["prevent"])),class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},[g.value&&!_.value?(a(),m("div",pa,[k(W,{name:"upload-cloud",class:"size-6 stroke-1.5 text-ink-gray-6 mx-auto mb-2.5"}),e("input",{ref_key:"fileInput",ref:j,type:"file",accept:".csv",class:"hidden",onChange:i[0]||(i[0]=H=>I(H))},null,544),e("div",{class:"leading-5 text-ink-gray-9"},[i[8]||(i[8]=Y(" Drag and drop a CSV file, or upload from your ",-1)),e("span",{onClick:v,class:"cursor-pointer font-semibold hover:underline"},"Device"),i[9]||(i[9]=Y(" or ",-1)),e("span",{onClick:x,class:"cursor-pointer font-semibold hover:underline"}," Google Sheet ")])])):g.value&&_.value?(a(),m("div",ca,[e("div",ma,[e("div",fa,E(f.value.name),1),e("div",va,E(z(y.value))+" of "+E(z(R.value)),1)]),e("div",ya,[e("div",{class:"bg-surface-gray-7 h-1 rounded-full transition-all duration-500 ease-in-out",style:oe(`width: ${V.value}%`)},null,4)])])):P("",!0)],32)):s.value?(a(),m("div",ga,[e("div",_a,[e("div",xa,[e("div",ba,E(s.value.file_name||s.value.split("/").pop()),1),s.value.file_size?(a(),m("div",ha,E(z(s.value.file_size)),1)):P("",!0)]),k(W,{name:"trash-2",class:"size-4 stroke-1.5 text-ink-red-3 cursor-pointer",onClick:b})])])):t.value?(a(),m("div",ka,[e("div",wa,[k(W,{name:"chevron-left",class:"size-4 cursor-pointer",onClick:w}),i[10]||(i[10]=e("div",null," Google Sheet ",-1))]),e("div",Ca,[De(e("input",{"onUpdate:modelValue":i[3]||(i[3]=H=>d.value=H),type:"text",class:"w-full border border-outline-gray-2 rounded-md px-2.5 text-base",placeholder:"Add Google Sheets Link"},null,512),[[Le,d.value]]),i[11]||(i[11]=e("div",{class:"text-ink-gray-5"}," Make sure the link is publically accessible to fetch the data. ",-1))])])):P("",!0),e("div",Sa,[k(Pe,{options:[{label:"Mandatory Fields",onClick(){$("mandatory")}},{label:"All Fields",onClick(){$("all")}},{label:"Custom Template",onClick(){L.value=!0}}]},{default:q(({open:H})=>[k(G,{variant:"ghost"},{prefix:q(()=>[k(W,{name:"download",class:"size-4 stroke-1.5"})]),suffix:q(()=>[k(W,{name:"chevron-down",class:J(["w-4 h-4 stroke-1.5 ml-1 transform transition-transform",H?"rotate-180":""])},null,8,["class"])]),default:q(()=>[i[12]||(i[12]=Y(" Download CSV Template ",-1))]),_:2},1024)]),_:1},8,["options"])])]),l.doctype||(O=l.data)!=null&&O.reference_doctype?(a(),B(oa,{key:0,modelValue:L.value,"onUpdate:modelValue":i[4]||(i[4]=H=>L.value=H),doctype:l.doctype||((ae=l.data)==null?void 0:ae.reference_doctype)},null,8,["modelValue","doctype"])):P("",!0)])}}}),Ia={class:"sticky flex items-center justify-between space-x-28 top-0 z-10 border-b bg-surface-white px-3 py-2.5 sm:px-5"},Ma=Z({__name:"DataImport",props:{label:{},description:{},doctype:{},importName:{},doctypeMap:{}},setup(D){const M=ke(),o=T("list"),s=T(null),d=D,_=Oe({doctype:"Data Import",fields:["name","reference_doctype","import_type","status","creation","mute_emails","import_file","google_sheets_url","template_options"],auto:!0,orderBy:"modified desc"}),f=ve({url:"frappe.desk.form.load.getdoctype",makeParams:g=>({doctype:g.doctype,with_parent:1}),auto:!1}),y=()=>{var g;s.value=((g=_.data)==null?void 0:g.find(t=>t.name===d.importName))||null};te(()=>[M.params,d,_.data],()=>{var g,t,u,n;d.doctype?(o.value="upload",f.reload({doctype:M.params.doctype})):d.importName&&(y(),!((g=s.value)!=null&&g.import_file)&&!((t=s.value)!=null&&t.google_sheets_url)?o.value="upload":o.value=="upload"&&M.query.step=="map"?o.value=M.query.step:o.value="preview",(u=s.value)!=null&&u.reference_doctype&&f.reload({doctype:(n=s.value)==null?void 0:n.reference_doctype}))},{immediate:!0}),te(()=>M.query,()=>{M.query.step=="list"&&(o.value="list")});const R=(g,t)=>{o.value=g,t&&(s.value=t)},L=N(()=>{var t,u,n;let g=d.doctype||((t=s.value)==null?void 0:t.reference_doctype);return((n=(u=d.doctypeMap)==null?void 0:u[g||""])==null?void 0:n.title)||g||""}),j=N(()=>{let g=[{label:"Data Import",route:{name:"DataImportList",query:{step:"list"}}}];return o.value!=="list"&&g.push({label:`Importing ${L.value}`}),g});return(g,t)=>{var u;return a(),m(K,null,[e("header",Ia,[k(je,{items:j.value},null,8,["items"]),o.value!="list"?(a(),B(ge,{key:0,class:"flex-1 hidden lg:flex",data:s.value,step:o.value,onUpdateStep:R},null,8,["data","step"])):P("",!0)]),e("div",null,[o.value!="list"?(a(),B(ge,{key:0,class:"flex-1 lg:hidden w-[90%] mx-auto mt-5",data:s.value,step:o.value,onUpdateStep:R},null,8,["data","step"])):P("",!0),o.value==="list"?(a(),B(lt,{key:1,dataImports:U(_),onUpdateStep:R},null,8,["dataImports"])):o.value==="upload"?(a(),B($a,{key:2,dataImports:U(_),doctype:g.doctype||((u=s.value)==null?void 0:u.reference_doctype),fields:U(f),data:s.value,onUpdateStep:R},null,8,["dataImports","doctype","fields","data"])):o.value==="map"?(a(),B(ft,{key:3,dataImports:U(_),data:s.value,fields:U(f),onUpdateStep:R},null,8,["dataImports","data","fields"])):o.value==="preview"?(a(),B(Kt,{key:4,dataImports:U(_),data:s.value,fields:U(f),doctypeMap:g.doctypeMap,onUpdateStep:R},null,8,["dataImports","data","fields","doctypeMap"])):P("",!0)])],64)}}}),Oa={__name:"DataImport",setup(D){const M=ke(),o={"CRM Lead":{title:"Leads",listRoute:"/crm/leads",pageRoute:"/crm/leads/docname"},"CRM Deal":{title:"Deals",listRoute:"/crm/deals",pageRoute:"/crm/deals/docname"},Contact:{title:"Contacts",listRoute:"/crm/contacts",pageRoute:"/crm/contacts/docname"},"CRM Task":{title:"Tasks",listRoute:"/crm/tasks"},"CRM Organization":{title:"Organizations",listRoute:"/crm/organizations",pageRoute:"/crm/organizations/docname"},"CRM Call Log":{title:"Call Log",listRoute:"/crm/call-logs"}};return Ue(()=>({title:__("Data Import")})),(s,d)=>(a(),B(U(Ma),{doctype:U(M).params.doctype,importName:U(M).params.importName,doctypeMap:o},null,8,["doctype","importName"]))}};export{Oa as default};
//# sourceMappingURL=DataImport-fb969f95.js.map
