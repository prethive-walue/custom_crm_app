import{a as Fe}from"./DeleteLinkedDocModal-e4ce4082.js";import{_ as We}from"./ErrorPage-b50e4529.js";import{_ as Ge}from"./Icon-caaa25f5.js";import{_ as Qe}from"./Resizer-c19d7118.js";import{u as Ze,_ as He,A as Je,a as de,b as Ke,c as Xe,S as Ye,L as ea}from"./useActiveTabManager-5cd0c16f.js";import{E as aa}from"./Popover-50f212fc.js";import{E as me}from"./Email2Icon-946daaf6.js";import{C as ta}from"./CommentIcon-ee876368.js";import{D as oa}from"./DetailsIcon-f1678fde.js";import{P as H}from"./PhoneIcon-abde0c26.js";import{T as sa}from"./TaskIcon-676b97ce.js";import{N as la}from"./NoteModal-f8390454.js";import{W as na}from"./WhatsAppIcon-7e1e6d5d.js";import{I as ia}from"./IndicatorIcon-69bb1f75.js";import{L as ra}from"./LinkIcon-d247e32f.js";import{A as ca}from"./ArrowUpRightIcon-7aa2e409.js";import{g as ua,S as da,a as ma}from"./view-8fc5f1fb.js";import{_ as pa}from"./LayoutHeader-2c6fb6af.js";import{_ as fa}from"./OrganizationModal-af9d5669.js";import{_ as _a}from"./LostReasonModal-d83970f6.js";import{C as va}from"./ContactModal-0863d6bf.js";import{_ as ga}from"./Link-472bc4cc.js";import{u as pe,_ as ya,b as ba}from"./modals-8694ff32.js";import{_ as fe}from"./CustomActions-587c3ded.js";import{b as ha,e as Ca,a as _e,o as ka,s as xa}from"./index-9b4a43f5.js";import{g as wa}from"./settings-979c7d03.js";import{g as Ia}from"./global-675ae1af.js";import{s as Da}from"./statuses-ec284dd7.js";import{w as Va,c as Aa}from"./DragVerticalIcon-c67f7b20.js";import{W as $a,$ as Sa,l as b,x as I,y as J,a as Ma,a1 as h,o as Ra,T as ve,r as ge,b as l,c as _,d as n,ah as za,w as d,u as o,ai as ye,g as p,A as c,F as be,a0 as N,n as K,e as v,t as x,U as he,f as Ta,Q as Ce,Z as Ea,E as Oa}from"./index-2806a214.js";import{u as Na}from"./onboarding-d2b14cdb.js";import{u as Ua}from"./pageMeta-ec5fe886.js";import{_ as Ba}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-3225a656.js";import{D as ke}from"./dayjs-40d38903.js";import"./ListView-e7793134.js";import"./CalendarIcon-3da65990.js";import"./CallLogModal-76a36b01.js";import"./ContactsIcon-255a97c3.js";import"./LeadsIcon-6ddbd86e.js";import"./DealsIcon-dcb19b30.js";import"./TaskModal-52bcf7e2.js";import"./FadedScrollableDiv-c128293b.js";import"./FieldLayout-eb509c1d.js";import"./MultipleAvatar-f547d53d.js";import"./IconPicker-b2b66c61.js";import"./FileUploader-44c6d7a3.js";import"./fileUploadHandler-0b2042a3.js";import"./plus-ad0e20b1.js";const La={key:0,class:"flex h-full overflow-hidden"},Pa={class:"flex items-center justify-start gap-5 border-b p-5"},qa={class:"group relative size-12"},ja={class:"flex flex-col gap-2.5 truncate text-ink-gray-9"},Fa={class:"truncate text-2xl font-medium"},Wa={class:"flex gap-1.5"},Ga={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Qa={key:0,class:"pr-2"},Za={key:0,class:"contacts-area"},Ha={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Ja={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},Ka=["onClick"],Xa={class:"truncate"},Ya={class:"flex items-center"},et={class:"flex flex-col gap-1.5 text-base"},at={key:0,class:"flex items-center gap-3 pb-1.5 pl-1 pt-4 text-ink-gray-8"},tt={key:1,class:"flex items-center gap-3 p-1 py-1.5 text-ink-gray-8"},ot={key:2,class:"flex items-center justify-center py-4 text-sm text-ink-gray-4"},st={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},lt={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},eo={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(C){const{brand:xe}=wa(),{$dialog:we,$socket:U,makeCall:Ie}=Ia(),{statusOptions:De,getDealStatus:B}=Da(),{doctypeMeta:Ve}=ha("CRM Deal"),{updateOnboardingStep:Ae,isOnboardingStepsCompleted:$e}=Na("frappecrm"),D=$a(),L=Sa(),k=C,V=b(""),P=b(""),S=b(!1),{triggerOnChange:Se,assignees:q,permissions:Me,document:i,scripts:X,error:Re}=pe("CRM Deal",k.dealId),ze=I(()=>{var e,a;return((a=(e=Me.data)==null?void 0:e.permissions)==null?void 0:a.delete)||!1}),u=I(()=>i.doc||{});J(Re,e=>{var a;e?(V.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),P.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(V.value="",P.value="")}),J(()=>i.doc,async e=>{var a;if((a=X.data)!=null&&a.length){let s=await xa(X.data,{doc:e,$dialog:we,$socket:U,router:L,toast:h,updateField:Q,createToast:h.create,deleteDoc:te,call:N});i._actions=s.actions||[],i._statuses=s.statuses||[]}},{once:!0});const j=b(null);J(()=>u.value.organization,e=>{var a;if(e&&!((a=j.value)!=null&&a.doc)){let{document:s}=pe("CRM Organization",e);j.value=s}},{immediate:!0});const Y=I(()=>{var e;return((e=j.value)==null?void 0:e.doc)||{}});Ma(()=>{U.on("crm_customer_created",()=>{h.success(__("Customer created successfully"))})}),Ra(()=>{U.off("crm_customer_created")});const F=b(!1),M=b(!1),W=b(!1),ee=b({}),Te=I(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(D.query.view||D.query.viewType){let a=ua(D.query.view,D.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:D.query.viewType},query:{view:D.query.view}}})}return e.push({label:R.value,route:{name:"Deal",params:{dealId:k.dealId}}}),e}),R=I(()=>{var a,s;let e=((a=Ve["CRM Deal"])==null?void 0:a.title_field)||"name";return((s=u.value)==null?void 0:s[e])||k.dealId}),Ee=I(()=>{var a;let e=(a=i.statuses)!=null&&a.length?i.statuses:i._statuses||[];return De("deal",e,Pe)});Ua(()=>({title:R.value,icon:xe.favicon}));const z=I(()=>[{name:"Activity",label:__("Activity"),icon:Je},{name:"Emails",label:__("Emails"),icon:aa},{name:"Comments",label:__("Comments"),icon:ta},{name:"Data",label:__("Data"),icon:oa},{name:"Calls",label:__("Calls"),icon:H},{name:"Tasks",label:__("Tasks"),icon:sa},{name:"Notes",label:__("Notes"),icon:la},{name:"Attachments",label:__("Attachments"),icon:de},{name:"WhatsApp",label:__("WhatsApp"),icon:na,condition:()=>Va.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:w}=Ze(z,"lastDealTab"),A=ve({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},transform:e=>Oe(e)});A.data||A.fetch();function Oe(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(s=>{s.fieldname=="organization"&&(s.create=(f,t)=>{ee.value.organization_name=f,M.value=!0,t()},s.link=f=>L.push({name:"Organization",params:{organizationId:f}}))})}),e}const T=b(!1),ae=b({});function Ne(e){let a=[{label:__("Remove"),icon:"trash-2",onClick:()=>Ue(e.name)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:Ea(ma,{class:"h-4 w-4"}),onClick:()=>Be(e.name)}),a}async function G(e){var s;if((s=g.data)!=null&&s.find(f=>f.name===e)){h.error(__("Contact already added"));return}await N("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:k.dealId,contact:e})&&(g.reload(),h.success(__("Contact added")))}async function Ue(e){await N("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:k.dealId,contact:e})&&(g.reload(),h.success(__("Contact removed")))}async function Be(e){await N("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:k.dealId,contact:e})&&(g.reload(),h.success(__("Primary contact set")))}const g=ve({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:k.dealId},cache:["deal_contacts",k.dealId],transform:e=>(e.forEach(a=>{a.opened=!1}),e)});g.data||g.fetch();function Le(){var s;let e=(s=g.data)==null?void 0:s.find(f=>f.is_primary),a=e.mobile_no||null;if(!e){h.error(__("No primary contact set"));return}if(!a){h.error(__("No mobile number set"));return}Ie(a)}async function Pe(e){await Se("status",e),oe()}function Q(e,a){e=="status"&&!$e.value&&Ae("change_deal_status"),a=Array.isArray(e)?"":a;let s=Array.isArray(e)?{}:u.value[e];Array.isArray(e)?e.forEach(f=>u.value[f]=a):u.value[e]=a,i.save.submit(null,{onSuccess:()=>F.value=!0,onError:f=>{var t;Array.isArray(e)?e.forEach(r=>u.value[r]=s[r]):u.value[e]=s,h.error(((t=f.messages)==null?void 0:t[0])||__("Error updating field"))}})}function te(){S.value=!0}const E=b(null);function qe(){let e=z.value[w.value];["Emails","Comments","Activities"].includes(e.name)||E.value.changeTabTo("emails"),Oa(()=>E.value.emailBox.show=!0)}const O=b(!1);function oe(){if(B(i.doc.status).type!=="Lost"||i.doc.lost_reason&&i.doc.lost_reason!=="Other"||i.doc.lost_reason==="Other"&&i.doc.lost_notes){i.save.submit();return}O.value=!0}function se(e){e!=null&&e.hasOwnProperty("status")&&B(e.status).type=="Lost"?oe():i.save.submit(null,{onSuccess:()=>Z(e)})}function Z(e){e!=null&&e.hasOwnProperty("deal_owner")&&q.reload()}return(e,a)=>{const s=ge("Button"),f=ge("Badge");return l(),_(be,null,[n(pa,null,za({"left-header":d(()=>[n(o(Ba),{items:Te.value},{prefix:d(({item:t})=>[t.icon?(l(),p(Ge,{key:0,icon:t.icon,class:"mr-2 h-4"},null,8,["icon"])):c("",!0)]),_:1},8,["items"])]),_:2},[V.value?void 0:{name:"right-header",fn:d(()=>{var t,r;return[(t=o(i)._actions)!=null&&t.length?(l(),p(fe,{key:0,actions:o(i)._actions},null,8,["actions"])):c("",!0),(r=o(i).actions)!=null&&r.length?(l(),p(fe,{key:1,actions:o(i).actions},null,8,["actions"])):c("",!0),n(Ke,{modelValue:o(q).data,"onUpdate:modelValue":a[0]||(a[0]=y=>o(q).data=y),doctype:"CRM Deal",docname:C.dealId},null,8,["modelValue","docname"]),u.value&&o(i).statuses?(l(),p(o(ke),{key:2,options:Ee.value,placement:"right"},{default:d(({open:y})=>[u.value.status?(l(),p(s,{key:0,label:u.value.status,iconRight:y?"chevron-up":"chevron-down"},{prefix:d(()=>[n(ia,{class:K(o(B)(u.value.status).color)},null,8,["class"])]),_:1},8,["label","iconRight"])):c("",!0)]),_:1},8,["options"])):c("",!0)]}),key:"0"}]),1024),u.value.name?(l(),_("div",La,[n(o(ya),{as:"div",modelValue:o(w),"onUpdate:modelValue":a[3]||(a[3]=t=>ye(w)?w.value=t:null),tabs:z.value,class:"flex flex-1 overflow-hidden flex-col [&_[role='tab']]:px-0 [&_[role='tablist']]:px-5 [&_[role='tablist']]:gap-7.5 [&_[role='tabpanel']:not([hidden])]:flex [&_[role='tabpanel']:not([hidden])]:grow"},{"tab-panel":d(()=>[n(Xe,{ref_key:"activities",ref:E,doctype:"CRM Deal",docname:C.dealId,tabs:z.value,reload:F.value,"onUpdate:reload":a[1]||(a[1]=t=>F.value=t),tabIndex:o(w),"onUpdate:tabIndex":a[2]||(a[2]=t=>ye(w)?w.value=t:null),onBeforeSave:se,onAfterSave:Z},null,8,["docname","tabs","reload","tabIndex"])]),_:1},8,["modelValue","tabs"]),n(Qe,{side:"right",class:"flex flex-col justify-between border-l"},{default:d(()=>{var t;return[v("div",{class:"flex h-[45px] cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:a[4]||(a[4]=r=>o(Ca)(C.dealId))},x(e.__(C.dealId)),1),v("div",Pa,[n(o(he),{text:e.__("Organization logo")},{default:d(()=>{var r;return[v("div",qa,[n(o(_e),{size:"3xl",class:"size-12",label:R.value,image:(r=Y.value)==null?void 0:r.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),v("div",ja,[n(o(he),{text:((t=Y.value)==null?void 0:t.name)||e.__("Set an organization")},{default:d(()=>[v("div",Fa,x(R.value),1)]),_:1},8,["text"]),v("div",Wa,[o(Aa)?(l(),p(s,{key:0,tooltip:e.__("Make a call"),icon:H,onClick:Le},null,8,["tooltip"])):c("",!0),n(s,{tooltip:e.__("Send an email"),icon:me,onClick:a[5]||(a[5]=r=>u.value.email?qe():o(h).error(e.__("No email set")))},null,8,["tooltip"]),n(s,{tooltip:e.__("Go to website"),icon:ra,onClick:a[6]||(a[6]=r=>u.value.website?o(ka)(u.value.website):o(h).error(e.__("No website set")))},null,8,["tooltip"]),n(s,{tooltip:e.__("Attach a file"),icon:de,onClick:a[7]||(a[7]=r=>W.value=!0)},null,8,["tooltip"]),ze.value?(l(),p(s,{key:1,tooltip:e.__("Delete"),variant:"subtle",icon:"trash-2",theme:"red",onClick:te},null,8,["tooltip"])):c("",!0)])])]),u.value.sla_status?(l(),p(Ye,{key:0,modelValue:u.value,"onUpdate:modelValue":a[8]||(a[8]=r=>u.value=r),onUpdateField:Q},null,8,["modelValue"])):c("",!0),o(A).data?(l(),_("div",Ga,[n(da,{sections:o(A).data,addContact:G,doctype:"CRM Deal",docname:C.dealId,onReload:o(A).reload,onBeforeFieldChange:se,onAfterFieldChange:Z},{actions:d(({section:r})=>[r.name=="contacts_section"?(l(),_("div",Qa,[n(ga,{value:"",doctype:"Contact",onChange:a[9]||(a[9]=y=>G(y)),onCreate:(y,$)=>{ae.value={first_name:y,company_name:u.value.organization},T.value=!0,$()}},{target:d(({togglePopover:y})=>[n(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:$=>y()},null,8,["onClick"])]),_:1},8,["onCreate"])])):c("",!0)]),default:d(({section:r})=>{var y,$,le,ne,ie;return[r.name=="contacts_section"?(l(),_("div",Za,[(y=o(g))!=null&&y.loading&&((le=($=o(g))==null?void 0:$.data)==null?void 0:le.length)==0?(l(),_("div",Ha,[n(ea,{class:"h-4 w-4"}),v("span",null,x(e.__("Loading...")),1)])):(ie=(ne=o(g))==null?void 0:ne.data)!=null&&ie.length?(l(!0),_(be,{key:1},Ta(o(g).data,(m,re)=>(l(),_("div",{key:m.name},[v("div",{class:K(["px-2 pb-2.5",[re==0?"pt-5":"pt-2.5"]])},[n(ba,{opened:m.opened},{header:d(({opened:je,toggle:ce})=>[v("div",Ja,[v("div",{class:"flex h-7 items-center gap-2 truncate",onClick:ue=>ce()},[n(o(_e),{label:m.full_name,image:m.image,size:"md"},null,8,["label","image"]),v("div",Xa,x(m.full_name),1),m.is_primary?(l(),p(f,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):c("",!0)],8,Ka),v("div",Ya,[n(o(ke),{options:Ne(m)},{default:d(()=>[n(s,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:1},8,["options"]),n(s,{variant:"ghost",tooltip:e.__("View contact"),icon:ca,onClick:ue=>o(L).push({name:"Contact",params:{contactId:m.name}})},null,8,["tooltip","onClick"]),n(s,{variant:"ghost",class:K(["transition-all duration-300 ease-in-out",{"rotate-90":je}]),icon:"chevron-right",onClick:ue=>ce()},null,8,["class","onClick"])])])]),default:d(()=>[v("div",et,[m.email?(l(),_("div",at,[n(me,{class:"h-4 w-4"}),Ce(" "+x(m.email),1)])):c("",!0),m.mobile_no?(l(),_("div",tt,[n(H,{class:"h-4 w-4"}),Ce(" "+x(m.mobile_no),1)])):c("",!0),!m.email&&!m.mobile_no?(l(),_("div",ot,x(e.__("No details added")),1)):c("",!0)])]),_:2},1032,["opened"])],2),re!=o(g).data.length-1?(l(),_("div",st)):c("",!0)]))),128)):(l(),_("div",lt,x(e.__("No contacts added")),1))])):c("",!0)]}),_:1},8,["sections","docname","onReload"])])):c("",!0)]}),_:1})])):V.value?(l(),p(We,{key:1,errorTitle:V.value,errorMessage:P.value},null,8,["errorTitle","errorMessage"])):c("",!0),M.value?(l(),p(fa,{key:2,modelValue:M.value,"onUpdate:modelValue":a[10]||(a[10]=t=>M.value=t),data:ee.value,options:{redirect:!1,afterInsert:t=>Q("organization",t.name)}},null,8,["modelValue","data","options"])):c("",!0),T.value?(l(),p(va,{key:3,modelValue:T.value,"onUpdate:modelValue":a[11]||(a[11]=t=>T.value=t),contact:ae.value,options:{redirect:!1,afterInsert:t=>G(t.name)}},null,8,["modelValue","contact","options"])):c("",!0),n(He,{modelValue:W.value,"onUpdate:modelValue":a[12]||(a[12]=t=>W.value=t),doctype:"CRM Deal",docname:C.dealId,onAfter:a[13]||(a[13]=()=>{var t,r;(r=(t=E.value)==null?void 0:t.all_activities)==null||r.reload(),e.changeTabTo("attachments")})},null,8,["modelValue","docname"]),S.value?(l(),p(Fe,{key:4,modelValue:S.value,"onUpdate:modelValue":a[14]||(a[14]=t=>S.value=t),doctype:"CRM Deal",docname:C.dealId,name:"Deals"},null,8,["modelValue","docname"])):c("",!0),O.value?(l(),p(_a,{key:5,modelValue:O.value,"onUpdate:modelValue":a[15]||(a[15]=t=>O.value=t),deal:o(i)},null,8,["modelValue","deal"])):c("",!0)],64)}}};export{eo as default};
//# sourceMappingURL=Deal-93d06d5f.js.map
